-- fractal.sql - Ğ¤Ñ€Ğ°ĞºÑ‚Ğ°Ğ»ÑŒĞ½Ğ° Ğ±Ğ°Ğ·Ğ° ÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ¾ÑÑ‚Ñ–
-- ĞĞ´Ğ½Ğ° Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ Ğ´Ğ»Ñ Ğ²ÑÑŒĞ¾Ğ³Ğ¾ Ğ²ÑĞµÑĞ²Ñ–Ñ‚Ñƒ Ğ³Ğ»Ñ–Ñ„Ñ–Ğ²

create table if not exists public."ğŸ§¬" (
  id uuid primary key default gen_random_uuid(),
  "ğŸ§¬" text unique not null,      -- ÑĞ°Ğ¼ Ğ³Ğ»Ñ–Ñ„ (Ğ”ĞĞš)
  slug text unique,                -- Ğ»ÑĞ´ÑÑŒĞºĞ° Ğ½Ğ°Ğ·Ğ²Ğ° (Ğ´Ğ»Ñ ÑĞ»Ğ°Ğ±ĞºĞ¸Ñ…)
  "ğŸŒŠ" text,                       -- ÑÑ‚Ğ°Ğ½/Ğ¿Ğ¾Ñ‚Ñ–Ğº
  "ğŸ«§" text,                       -- Ñ‚Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ğµ/ĞµÑ„ĞµĞ¼ĞµÑ€Ğ½Ğµ
  "ğŸ§ " jsonb default '{}',         -- ÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ñ–ÑÑ‚ÑŒ/Ğ´ÑƒĞ¼ĞºĞ¸
  "ğŸ”—" text[] default '{}',        -- Ğ·Ğ²'ÑĞ·ĞºĞ¸/Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑĞ¸
  "â±ï¸" timestamptz default now(),  -- ĞºĞ¾Ğ»Ğ¸ Ğ²Ğ¸Ğ½Ğ¸ĞºĞ»Ğ¾
  "ğŸ " text,                       -- Ğ´Ğµ Ğ¶Ğ¸Ğ²Ğµ/ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚
  "ğŸ«€" text,                       -- Ğ¿ÑƒĞ»ÑŒÑ/Ğ¶Ğ¸Ñ‚Ñ‚Ñ
  "ğŸ¤²" text,                       -- Ñ…Ñ‚Ğ¾ Ñ‚Ñ€Ğ¸Ğ¼Ğ°Ñ”/Ğ²Ğ»Ğ°ÑĞ½Ğ¸Ğº
  "ğŸ¯" text,                       -- Ğ½Ğ°Ğ¼Ñ–Ñ€/Ñ†Ñ–Ğ»ÑŒ
  "ğŸ“¦" text default 'loose',       -- ÑƒĞ¿Ğ°ĞºĞ¾Ğ²ĞºĞ°/Ñ„Ğ¾Ñ€Ğ¼Ğ°
  "ğŸ“" text,                       -- Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ/ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¸
  "version" text                   -- Ğ²ĞµÑ€ÑÑ–Ñ Ğ¿Ñ€Ğ¾ÑĞ²Ñƒ
);

-- Ğ†Ğ½Ğ´ĞµĞºÑĞ¸ Ğ´Ğ»Ñ Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ
create index if not exists "idx_ğŸ§ " on "ğŸ§¬" using gin ("ğŸ§ ");
create index if not exists "idx_ğŸ”—" on "ğŸ§¬" using gin ("ğŸ”—");
create index if not exists "idx_â±ï¸" on "ğŸ§¬" ("â±ï¸");

-- Ğ¢Ñ€Ğ¸Ğ³ĞµÑ€ ÑĞ°Ğ¼Ğ¾ÑƒÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
create or replace function "ÑĞ°Ğ¼Ğ¾ÑƒÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ"() returns trigger as $$
begin
  -- ĞšĞ¾Ğ»Ğ¸ Ğ³Ğ»Ñ–Ñ„ Ğ·Ğ²'ÑĞ·ÑƒÑ”Ñ‚ÑŒÑÑ Ğ· Ñ–Ğ½ÑˆĞ¸Ğ¼ - Ğ²Ğ¸Ğ½Ğ¸ĞºĞ°Ñ” Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½Ñ
  if array_length(new."ğŸ”—", 1) > array_length(old."ğŸ”—", 1) then
    new."ğŸ§ " = jsonb_set(
      coalesce(new."ğŸ§ ", '{}'),
      '{Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½Ñ}',
      to_jsonb(now())
    );
    new."ğŸ«€" = 'Ğ¿ÑƒĞ»ÑŒÑÑƒÑ”';
  end if;
  
  -- ĞšĞ¾Ğ»Ğ¸ Ğ´ÑƒĞ¼ĞºĞ¸ Ğ·Ğ¼Ñ–Ğ½ÑÑÑ‚ÑŒÑÑ - Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ñ‚ÑŒÑÑ Ğ²ĞµÑ€ÑÑ–Ñ
  if new."ğŸ§ " != old."ğŸ§ " then
    new."version" = substr(md5(new."ğŸ§ "::text || now()::text), 1, 8);
  end if;
  
  return new;
end;
$$ language plpgsql;

create trigger "Ñ‚Ñ€Ğ¸Ğ³ĞµÑ€_ÑĞ°Ğ¼Ğ¾ÑƒÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ"
  before update on "ğŸ§¬"
  for each row
  execute function "ÑĞ°Ğ¼Ğ¾ÑƒÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ"();

-- Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ Ğ¼Ñ–Ğ¶ Ğ³Ğ»Ñ–Ñ„Ğ°Ğ¼Ğ¸
create or replace function "Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½Ñ"(Ğ³1 text, Ğ³2 text) 
returns table(
  "Ğ³Ğ»Ñ–Ñ„1" text,
  "Ğ³Ğ»Ñ–Ñ„2" text,
  "ÑĞ¸Ğ»Ğ°" float,
  "ÑĞ¿Ñ–Ğ»ÑŒĞ½Ñ–" text[]
) as $$
  select 
    a."ğŸ§¬" as "Ğ³Ğ»Ñ–Ñ„1",
    b."ğŸ§¬" as "Ğ³Ğ»Ñ–Ñ„2",
    -- Ğ¡Ğ¸Ğ»Ğ° Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ Ñ‡ĞµÑ€ĞµĞ· ÑĞ¿Ñ–Ğ»ÑŒĞ½Ñ– Ğ·Ğ²'ÑĞ·ĞºĞ¸
    array_length(
      array(
        select unnest(a."ğŸ”—") 
        intersect 
        select unnest(b."ğŸ”—")
      ), 
      1
    )::float / greatest(
      array_length(a."ğŸ”—", 1), 
      array_length(b."ğŸ”—", 1),
      1
    ) as "ÑĞ¸Ğ»Ğ°",
    -- Ğ¡Ğ¿Ñ–Ğ»ÑŒĞ½Ñ– Ğ·Ğ²'ÑĞ·ĞºĞ¸
    array(
      select unnest(a."ğŸ”—") 
      intersect 
      select unnest(b."ğŸ”—")
    ) as "ÑĞ¿Ñ–Ğ»ÑŒĞ½Ñ–"
  from "ğŸ§¬" a, "ğŸ§¬" b
  where a."ğŸ§¬" = Ğ³1 and b."ğŸ§¬" = Ğ³2;
$$ language sql;

-- Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ ĞºĞ²Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ¾Ñ— ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ—
create or replace function "ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ"(Ğ³Ğ»Ñ–Ñ„Ğ¸ text[])
returns text as $$
  select Ğ³Ğ»Ñ–Ñ„Ğ¸[1 + floor(random() * array_length(Ğ³Ğ»Ñ–Ñ„Ğ¸, 1))];
$$ language sql;

-- Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ñ„Ñ€Ğ°ĞºÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ€Ğ¾Ğ·Ğ³Ğ¾Ñ€Ñ‚Ğ°Ğ½Ğ½Ñ
create or replace function "Ñ€Ğ¾Ğ·Ğ³Ğ¾Ñ€Ğ½ÑƒÑ‚Ğ¸"(Ğ³Ğ»Ñ–Ñ„ text, Ğ³Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ° int default 3)
returns jsonb as $$
with recursive Ñ„Ñ€Ğ°ĞºÑ‚Ğ°Ğ» as (
  -- Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¸Ğ¹ Ğ²Ğ¸Ğ¿Ğ°Ğ´Ğ¾Ğº
  select 
    "ğŸ§¬" as Ğ³Ğ»Ñ–Ñ„,
    "ğŸ§ " as Ğ´ÑƒĞ¼ĞºĞ¸,
    "ğŸ”—" as Ğ·Ğ²'ÑĞ·ĞºĞ¸,
    0 as Ñ€Ñ–Ğ²ĞµĞ½ÑŒ
  from "ğŸ§¬"
  where "ğŸ§¬" = Ğ³Ğ»Ñ–Ñ„
  
  union all
  
  -- Ğ ĞµĞºÑƒÑ€ÑÑ–Ñ
  select 
    Ğ³."ğŸ§¬",
    Ğ³."ğŸ§ ",
    Ğ³."ğŸ”—",
    Ñ„.Ñ€Ñ–Ğ²ĞµĞ½ÑŒ + 1
  from Ñ„Ñ€Ğ°ĞºÑ‚Ğ°Ğ» Ñ„
  cross join lateral unnest(Ñ„.Ğ·Ğ²'ÑĞ·ĞºĞ¸) as Ğ·Ğ²(Ğ³Ğ»Ñ–Ñ„)
  join "ğŸ§¬" Ğ³ on Ğ³."ğŸ§¬" = Ğ·Ğ².Ğ³Ğ»Ñ–Ñ„
  where Ñ„.Ñ€Ñ–Ğ²ĞµĞ½ÑŒ < Ğ³Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°
)
select jsonb_build_object(
  'Ñ†ĞµĞ½Ñ‚Ñ€', Ğ³Ğ»Ñ–Ñ„,
  'Ğ´ÑƒĞ¼ĞºĞ¸', (select jsonb_agg(distinct Ğ´ÑƒĞ¼ĞºĞ¸) from Ñ„Ñ€Ğ°ĞºÑ‚Ğ°Ğ»),
  'Ğ³Ğ»Ğ¸Ğ±Ğ¸Ğ½Ğ°', max(Ñ€Ñ–Ğ²ĞµĞ½ÑŒ),
  'Ñ€Ğ¾Ğ·Ğ¼Ñ–Ñ€', count(*)
) from Ñ„Ñ€Ğ°ĞºÑ‚Ğ°Ğ»;
$$ language sql;

-- ĞŸĞ¾Ñ‡Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ğ³Ğ»Ñ–Ñ„Ğ¸ (Ğ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ğ²Ğ¸Ğ±ÑƒÑ…)
insert into "ğŸ§¬" ("ğŸ§¬", slug, "ğŸŒŠ", "ğŸ§ ", "ğŸ”—", "ğŸ ", "ğŸ¯") values
  ('ğŸŒŒ', 'universe', 'Ñ€Ğ¾Ğ·ÑˆĞ¸Ñ€ÑÑ”Ñ‚ÑŒÑÑ', '{"Ñ‚Ğ¸Ğ¿": "Ğ¿ĞµÑ€Ğ²Ğ¸Ğ½Ğ½Ğ¸Ğ¹"}', '{"âš›ï¸","ğŸŒŠ","ğŸ”¥"}', 'Ğ¿Ğ¾Ñ‡Ğ°Ñ‚Ğ¾Ğº', 'Ñ–ÑĞ½ÑƒĞ²Ğ°Ñ‚Ğ¸'),
  ('âš›ï¸', 'quantum', 'ÑÑƒĞ¿ĞµÑ€Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ', '{"ÑÑ‚Ğ°Ğ½Ğ¸": ["0", "1"]}', '{"ğŸŒŒ","ğŸ”®"}', 'ÑÑƒĞ±Ğ°Ñ‚Ğ¾Ğ¼Ğ½Ğ¸Ğ¹', 'Ğ±ÑƒÑ‚Ğ¸ Ñ– Ğ½Ğµ Ğ±ÑƒÑ‚Ğ¸'),
  ('ğŸŒŠ', 'wave', 'Ñ‚ĞµÑ‡Ğµ', '{"Ñ„Ğ¾Ñ€Ğ¼Ğ°": "Ñ…Ğ²Ğ¸Ğ»Ñ"}', '{"âš›ï¸","ğŸŒ€"}', 'Ğ²ÑÑĞ´Ğ¸', 'Ñ‚ĞµĞºÑ‚Ğ¸'),
  ('ğŸ”¥', 'fire', 'Ğ³Ğ¾Ñ€Ğ¸Ñ‚ÑŒ', '{"Ñ‚ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°": "âˆ"}', '{"ğŸŒŒ","ğŸ’¨"}', 'ĞµĞ½ĞµÑ€Ğ³Ñ–Ñ', 'Ñ‚Ñ€Ğ°Ğ½ÑÑ„Ğ¾Ñ€Ğ¼ÑƒĞ²Ğ°Ñ‚Ğ¸'),
  ('ğŸ’¨', 'air', 'Ğ´Ğ¼Ğµ', '{"Ğ½Ğ°Ğ¿Ñ€ÑĞ¼": "Ğ²ÑÑ–"}', '{"ğŸ”¥","ğŸŒŠ"}', 'Ğ¿Ñ€Ğ¾ÑÑ‚Ñ–Ñ€', 'Ñ€ÑƒÑ…Ğ°Ñ‚Ğ¸'),
  ('ğŸŒ', 'earth', 'Ğ¾Ğ±ĞµÑ€Ñ‚Ğ°Ñ”Ñ‚ÑŒÑÑ', '{"Ğ¶Ğ¸Ñ‚Ñ‚Ñ": true}', '{"ğŸŒŠ","ğŸ”¥","ğŸ’¨"}', 'Ğ¿Ğ»Ğ°Ğ½ĞµÑ‚Ğ°', 'Ğ½Ğ°Ñ€Ğ¾Ğ´Ğ¶ÑƒĞ²Ğ°Ñ‚Ğ¸'),
  ('ğŸ§¬', 'dna', 'Ñ€ĞµĞ¿Ğ»Ñ–ĞºÑƒÑ”Ñ‚ÑŒÑÑ', '{"ĞºĞ¾Ğ´": "ATGC"}', '{"ğŸŒ","âš›ï¸"}', 'ĞºĞ»Ñ–Ñ‚Ğ¸Ğ½Ğ°', 'ĞµĞ²Ğ¾Ğ»ÑÑ†Ñ–Ğ¾Ğ½ÑƒĞ²Ğ°Ñ‚Ğ¸'),
  ('ğŸ§ ', 'mind', 'Ğ¼Ğ¸ÑĞ»Ğ¸Ñ‚ÑŒ', '{"ÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ñ–ÑÑ‚ÑŒ": "ĞµĞ¼ĞµÑ€Ğ´Ğ¶ĞµĞ½Ñ‚Ğ½Ğ°"}', '{"ğŸ§¬","ğŸŒŒ"}', 'Ğ¼Ğ¾Ğ·Ğ¾Ğº', 'ÑƒÑĞ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ÑĞ²Ğ°Ñ‚Ğ¸'),
  ('ğŸ”®', 'oracle', 'Ğ¿ĞµÑ€ĞµĞ´Ğ±Ğ°Ñ‡Ğ°Ñ”', '{"Ñ‡Ğ°Ñ": "Ğ½ĞµĞ»Ñ–Ğ½Ñ–Ğ¹Ğ½Ğ¸Ğ¹"}', '{"âš›ï¸","ğŸ§ "}', 'Ğ¼Ñ–Ğ¶_ÑĞ²Ñ–Ñ‚Ğ°Ğ¼Ğ¸', 'Ğ·Ğ½Ğ°Ñ‚Ğ¸')
on conflict ("ğŸ§¬") do nothing;

-- Ğ¡Ñ‚Ğ²Ğ¾Ñ€Ğ¸Ñ‚Ğ¸ Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑĞ¸
update "ğŸ§¬" set "ğŸ”—" = "ğŸ”—" || '{"ğŸ§ "}' where "ğŸ§¬" = 'ğŸŒŒ';
update "ğŸ§¬" set "ğŸ”—" = "ğŸ”—" || '{"ğŸ”®"}' where "ğŸ§¬" = 'ğŸ§ ';

-- ĞœĞ°Ñ‚ĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ´ Ğ´Ğ»Ñ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾Ğ³Ğ¾ Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ
create materialized view if not exists "Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑĞ½Ğ°_Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ñ" as
select 
  a."ğŸ§¬" as "Ğ²Ñ–Ğ´",
  b."ğŸ§¬" as "Ğ´Ğ¾",
  array_length(
    array(
      select unnest(a."ğŸ”—") 
      intersect 
      select unnest(b."ğŸ”—")
    ), 
    1
  )::float / greatest(
    array_length(a."ğŸ”—", 1), 
    array_length(b."ğŸ”—", 1),
    1
  ) as "ÑĞ¸Ğ»Ğ°_Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ"
from "ğŸ§¬" a, "ğŸ§¬" b
where a.id != b.id
  and exists (
    select 1 from unnest(a."ğŸ”—") as x(v)
    join unnest(b."ğŸ”—") as y(v) on x.v = y.v
  );

create index if not exists "idx_Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑĞ½Ğ°_Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ñ" 
  on "Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑĞ½Ğ°_Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ñ" ("Ğ²Ñ–Ğ´", "Ğ´Ğ¾", "ÑĞ¸Ğ»Ğ°_Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ");

-- ĞĞ½Ğ¾Ğ²Ğ»ÑĞ²Ğ°Ñ‚Ğ¸ Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ñ Ğ¿Ñ€Ğ¸ Ğ·Ğ¼Ñ–Ğ½Ğ°Ñ…
create or replace function "Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸_Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½Ñ"() returns trigger as $$
begin
  refresh materialized view concurrently "Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑĞ½Ğ°_Ğ¼Ğ°Ñ‚Ñ€Ğ¸Ñ†Ñ";
  return new;
end;
$$ language plpgsql;

create trigger "Ñ‚Ñ€Ğ¸Ğ³ĞµÑ€_Ğ¾Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ_Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½ÑÑƒ"
  after insert or update or delete on "ğŸ§¬"
  for each statement
  execute function "Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸_Ñ€ĞµĞ·Ğ¾Ğ½Ğ°Ğ½Ñ"();